<!DOCTYPE html>
<html>
  <head>
    <title>Keshav Yuvak Mandal</title>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <link href="https://fonts.googleapis.com/css2?family=Sora:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <style>
      /* --- THEME VARIABLES --- */
      :root {
        --primary: #0e3e52; 
        --primary-gradient: linear-gradient(135deg, #0e3e52 0%, #155e7a 100%);
        --accent: #0ea5e9;
        --bg: #f3f4f6;
        --white: #ffffff;
        --text-dark: #111827;
        --text-grey: #6b7280;
        --border: #e5e7eb;
        --success: #10b981;
        --danger: #ef4444;
      }
      
      * { box-sizing: border-box; margin: 0; padding: 0; }
      
      body { 
        font-family: 'Sora', sans-serif; 
        background-color: var(--bg); 
        color: var(--text-dark);
        -webkit-tap-highlight-color: transparent; 
      }
      
      .hidden { display: none !important; }

      /* --- ICONS (SVG CLASS) --- */
      .icon { width: 20px; height: 20px; stroke: currentColor; stroke-width: 2; fill: none; stroke-linecap: round; stroke-linejoin: round; }
      .icon-sm { width: 16px; height: 16px; margin-right: 5px; }

      /* --- BUTTONS --- */
      .btn-primary {
        width: 100%; padding: 14px;
        background: var(--primary-gradient); 
        color: white;
        border: none; border-radius: 12px;
        font-size: 16px; font-weight: 600; cursor: pointer;
        box-shadow: 0 4px 6px -1px rgba(14, 62, 82, 0.3);
        transition: transform 0.1s;
      }
      .btn-primary:active { transform: scale(0.98); }

      .icon-btn { 
        background: transparent; border: none; cursor: pointer; 
        padding: 8px; color: inherit; border-radius: 50%;
        display: flex; align-items: center; justify-content: center;
      }
      .icon-btn:hover { background: rgba(0,0,0,0.05); }

      /* --- LOGIN SCREEN --- */
      .login-wrapper {
        display: flex; align-items: center; justify-content: center;
        min-height: 100vh; padding: 20px; background: var(--bg);
      }
      
      .login-card {
        background: white; width: 100%; padding: 40px;
        border-radius: 20px;
        box-shadow: 0 10px 25px rgba(0,0,0,0.05);
        display: flex; flex-direction: column; align-items: center;
      }

      @media (min-width: 768px) {
        .login-card { max-width: 650px; padding: 60px; }
      }

      /* Vector Image Styling */
      .vector-img {
        width: 180px; height: auto; margin-bottom: 30px;
      }

      .login-title { font-size: 24px; font-weight: 700; color: var(--primary); margin-bottom: 10px; }
      .login-sub { font-size: 14px; color: var(--text-grey); text-align: center; margin-bottom: 40px; max-width: 80%; line-height: 1.6; }
      
      .input-group { width: 100%; margin-bottom: 20px; }
      .input-label { display: block; font-size: 14px; font-weight: 600; margin-bottom: 8px; color: var(--text-dark); }
      .login-input {
        width: 100%; padding: 14px 16px;
        border: 1px solid var(--border); border-radius: 10px;
        font-size: 15px; outline: none; background: #f9fafb;
        font-family: 'Sora', sans-serif;
      }
      .login-input:focus { border-color: var(--primary); background: white; }

      /* --- APP LAYOUT --- */
      .app-wrapper { width: 100%; min-height: 100vh; display: flex; flex-direction: column; }

      @media (min-width: 1024px) {
        .app-wrapper { max-width: 1000px; margin: 0 auto; border-left: 1px solid #eee; border-right: 1px solid #eee; background: white; }
        body { background-color: #e5e7eb; } 
      }

      /* --- HEADERS --- */
      .app-header {
        background: var(--primary); color: white;
        padding: 16px 24px; display: flex; align-items: center; justify-content: space-between;
        position: sticky; top: 0; z-index: 100;
        box-shadow: 0 4px 12px rgba(0,0,0,0.08);
      }
      .header-title { font-size: 18px; font-weight: 700; display:flex; align-items: center; gap: 10px; }
      
      .secondary-header {
        background: white; padding: 16px 24px; border-bottom: 1px solid #eee; 
        display: flex; align-items: center; justify-content: space-between;
        position: sticky; top: 0; z-index: 90;
      }
      
      /* DESKTOP NAV */
      .desktop-nav { display: none; gap: 15px; }
      .mobile-menu-btn { display: block; }

      @media (min-width: 1024px) {
        .desktop-nav { display: flex; align-items: center; }
        .mobile-menu-btn { display: none; }
        .sidebar-overlay { display: none !important; }
      }

      .nav-link { 
        color: rgba(255,255,255,0.8); font-size: 14px; font-weight: 600; cursor: pointer; 
        padding: 8px 12px; border-radius: 6px; display: flex; align-items: center; gap: 6px;
      }
      .nav-link:hover { background: rgba(255,255,255,0.1); color: white; }

      /* --- SEARCH BOX (Used in Home and Attendance) --- */
      .search-box { padding: 10px 24px; position: relative; background: white; }
      .search-input { 
        width: 100%; padding: 12px 15px 12px 45px; 
        border: 1px solid var(--border); border-radius: 12px; 
        outline: none; font-size: 15px; font-family: 'Sora', sans-serif;
        background: #f9fafb;
      }
      .search-input:focus { background: white; border-color: var(--primary); }
      .search-icon-pos { position: absolute; left: 38px; top: 22px; color: #9ca3af; }

      /* --- EVENT LIST --- */
      .event-list { padding: 24px; display: flex; flex-direction: column; gap: 16px; }
      .event-card {
        background: white; border-radius: 12px; padding: 20px;
        border: 1px solid var(--border); border-left: 5px solid var(--accent);
        box-shadow: 0 2px 4px rgba(0,0,0,0.02);
        cursor: pointer; transition: transform 0.2s;
      }
      .event-card:hover { transform: translateY(-2px); box-shadow: 0 8px 16px rgba(0,0,0,0.06); }

      /* --- GRID --- */
      .grid-container { padding: 20px; display: flex; flex-direction: column; gap: 20px; padding-bottom: 100px; }
      .mandal-card { background: white; border: 1px solid var(--border); border-radius: 12px; overflow: hidden; }
      .mandal-header { 
        background: #f8fafc; padding: 12px 20px; 
        font-weight: 700; font-size: 14px; color: var(--text-dark);
        border-bottom: 1px solid var(--border); 
        display:flex; justify-content:space-between; align-items: center;
      }
      .user-row { 
        display: flex; align-items: center; justify-content: space-between; 
        padding: 14px 20px; border-bottom: 1px solid #f1f5f9; 
      }
      
      .u-name { font-weight: 600; font-size: 15px; color: var(--text-dark); }
      .u-meta { font-size: 12px; color: var(--text-grey); margin-top: 4px; display: flex; align-items: center; gap: 5px; }
      
      .status-btn { 
        padding: 8px 16px; border-radius: 30px; border: none; 
        font-size: 13px; font-weight: 600; cursor: pointer; width: 90px; 
        transition: all 0.2s; font-family: 'Sora', sans-serif;
      }
      .is-absent { background: #f3f4f6; color: #6b7280; border: 1px solid #e5e7eb; }
      .is-present { background: var(--success); color: white; box-shadow: 0 4px 6px rgba(16, 185, 129, 0.3); }
      .status-btn:active { transform: scale(0.95); }

      /* --- REPORT --- */
      .report-container { padding: 0; background: white; min-height: calc(100vh - 70px); }
      .r-table { width: 100%; border-collapse: collapse; }
      .r-table th { text-align: left; padding: 16px 20px; background: #f8fafc; font-size: 13px; font-weight: 700; border-bottom: 1px solid var(--border); text-transform: uppercase; }
      .r-table td { padding: 16px 20px; border-bottom: 1px solid #f1f5f9; font-size: 14px; }
      .r-total-row { background: #ecfdf5; }

      /* --- SIDEBAR --- */
      .sidebar-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 998; display: none; }
      .sidebar { position: fixed; top: 0; left: -280px; width: 280px; height: 100%; background: white; z-index: 999; transition: left 0.3s; padding: 20px; display: flex; flex-direction: column; }
      .sidebar.active { left: 0; }
      .sb-header { font-size: 20px; font-weight: 800; color: var(--primary); margin-bottom: 30px; padding-bottom: 20px; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; align-items: center; }
      .sb-item { display: flex; align-items: center; gap: 12px; padding: 16px; border-radius: 12px; cursor: pointer; color: var(--text-dark); font-weight: 600; transition: background 0.1s; }
      .sb-item:hover { background: #f3f4f6; }
      
      .fab { 
        position: fixed; bottom: 30px; right: 30px; 
        width: 60px; height: 60px; 
        background: var(--primary-gradient); color: white; 
        border-radius: 50%; border: none; 
        box-shadow: 0 8px 20px rgba(14, 62, 82, 0.4);
        cursor: pointer; z-index: 200;
        display: flex; align-items: center; justify-content: center;
        transition: transform 0.2s;
      }
      .fab:hover { transform: scale(1.05); }

      /* --- MODAL --- */
      .modal { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.6); z-index: 1000; align-items: center; justify-content: center; backdrop-filter: blur(2px); }
      .modal-card { background: white; padding: 30px; border-radius: 16px; width: 90%; max-width: 400px; box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1); }
    </style>
  </head>
  <body>

    <div id="view-login" class="login-wrapper">
      <div class="login-card">
        <img src="vector.svg" alt="Login Illustration" class="vector-img">
      
        <div class="login-title">Keshav Yuvak Mandal</div>
        <div class="login-sub">Streamline attendance tracking for multiple events with efficiency.</div>

        <div class="input-group">
          <label class="input-label">User ID</label>
          <input type="text" id="email" class="login-input" placeholder="Enter User ID">
        </div>

        <div class="input-group">
          <label class="input-label">Password</label>
          <input type="password" id="password" class="login-input" placeholder="Enter Password">
        </div>

        <button class="btn-primary" onclick="handleLogin()" id="loginBtn">
          Login Account
        </button>
        <p id="login-error" style="color:var(--danger); font-size:13px; margin-top:15px; display:none; text-align: center;"></p>
      </div>
    </div>


    <div id="app-wrapper" class="app-wrapper hidden">
      
      <div class="app-header">
        <div class="header-title">
           <button class="icon-btn mobile-menu-btn" onclick="toggleSidebar()">
             <svg class="icon" viewBox="0 0 24 24"><path d="M4 6h16M4 12h16M4 18h16"></path></svg>
           </button>
           <span>Keshav Yuvak Mandal</span>
        </div>
        
        <div class="desktop-nav">
           <div class="nav-link" onclick="goTo('home')">
             <svg class="icon icon-sm" viewBox="0 0 24 24"><path d="M3 9l9-7 9 7v11a2 2 0 01-2 2H5a2 2 0 01-2-2z"></path><polyline points="9 22 9 12 15 12 15 22"></polyline></svg>
             Events
           </div>
           <div class="nav-link" onclick="handleLogout()" style="color:#fca5a5;">
             <svg class="icon icon-sm" viewBox="0 0 24 24"><path d="M9 21H5a2 2 0 01-2-2V5a2 2 0 012-2h4"></path><polyline points="16 17 21 12 16 7"></polyline><line x1="21" y1="12" x2="9" y2="12"></line></svg>
             Logout
           </div>
        </div>
      </div>

      <div id="view-home" class="hidden">
        <div class="search-box">
          <span class="search-icon-pos">
            <svg class="icon" style="color:#9ca3af" viewBox="0 0 24 24"><circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line></svg>
          </span>
          <input type="text" class="search-input" id="eventSearch" onkeyup="filterEvents()" placeholder="Search Events...">
        </div>

        <div class="event-list" id="eventListContainer"></div>
        
        <button class="fab" onclick="showAddModal()">
          <svg class="icon" style="width:30px; height:30px;" viewBox="0 0 24 24"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>
        </button>
      </div>

      <div id="view-attendance" class="hidden">
        <div class="secondary-header">
          <div style="display:flex; align-items:center; gap:10px;">
            <button class="icon-btn" onclick="goTo('home')" title="Back to Events">
               <svg class="icon" style="color:var(--text-dark);" viewBox="0 0 24 24"><line x1="19" y1="12" x2="5" y2="12"></line><polyline points="12 19 5 12 12 5"></polyline></svg>
            </button>
            <span class="page-title" id="currentEventTitle">Event Name</span>
          </div>
          <button class="icon-btn" onclick="goTo('report')" title="View Report" style="color:var(--primary)">
             <svg class="icon" viewBox="0 0 24 24"><line x1="18" y1="20" x2="18" y2="10"></line><line x1="12" y1="20" x2="12" y2="4"></line><line x1="6" y1="20" x2="6" y2="14"></line></svg>
          </button>
        </div>

        <div class="search-box" style="border-bottom: 1px solid #eee;">
            <span class="search-icon-pos" style="top:22px;">
              <svg class="icon" style="color:#9ca3af" viewBox="0 0 24 24"><circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line></svg>
            </span>
            <input type="text" class="search-input" id="studentSearch" onkeyup="filterStudents()" placeholder="Search Name...">
        </div>

        <div class="grid-container" id="attendanceGrid"></div>
      </div>

      <div id="view-report" class="hidden">
        <div class="secondary-header">
          <div style="display:flex; align-items:center; gap:10px;">
            <button class="icon-btn" onclick="goTo('attendance')">
               <svg class="icon" style="color:var(--text-dark);" viewBox="0 0 24 24"><line x1="19" y1="12" x2="5" y2="12"></line><polyline points="12 19 5 12 12 5"></polyline></svg>
            </button>
            <span class="page-title">Attendance Report</span>
          </div>
          <button class="icon-btn" onclick="downloadCSV()" title="Download Excel" style="color:var(--success)">
             <svg class="icon" viewBox="0 0 24 24"><path d="M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4"></path><polyline points="7 10 12 15 17 10"></polyline><line x1="12" y1="15" x2="12" y2="3"></line></svg>
          </button>
        </div>
        
        <div class="report-container">
          <table class="r-table">
            <thead>
              <tr><th>Mandal</th><th>Present</th><th>Total</th><th>%</th></tr>
            </thead>
            <tbody id="reportTableBody"></tbody>
          </table>
        </div>
      </div>

    </div> <div class="sidebar-overlay" id="sidebarOverlay" onclick="toggleSidebar()"></div>
    <div class="sidebar" id="sidebar">
       <div class="sb-header">
          <span>Menu</span>
          <button class="icon-btn" onclick="toggleSidebar()">
             <svg class="icon" viewBox="0 0 24 24"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
          </button>
       </div>
       <div class="sb-item" onclick="goTo('home'); toggleSidebar()">
          <svg class="icon" viewBox="0 0 24 24"><path d="M3 9l9-7 9 7v11a2 2 0 01-2 2H5a2 2 0 01-2-2z"></path><polyline points="9 22 9 12 15 12 15 22"></polyline></svg>
          Events List
       </div>
       <div class="sb-item" onclick="handleLogout()" style="color:var(--danger)">
          <svg class="icon" viewBox="0 0 24 24"><path d="M9 21H5a2 2 0 01-2-2V5a2 2 0 012-2h4"></path><polyline points="16 17 21 12 16 7"></polyline><line x1="21" y1="12" x2="9" y2="12"></line></svg>
          Logout
       </div>
    </div>

    <div id="addModal" class="modal">
      <div class="modal-card">
        <h3 style="margin-bottom:15px; font-weight:700;">Create New Event</h3>
        <div class="input-group">
           <label class="input-label">Event Name</label>
           <input type="text" id="newEventInput" class="login-input" placeholder="e.g. 25-10-2025">
        </div>
        <button class="btn-primary" onclick="addNewEvent()">Create Event</button>
        <button onclick="document.getElementById('addModal').style.display='none'" style="width:100%; margin-top:10px; background:white; border:none; padding:12px; cursor:pointer; font-weight:600; color:var(--text-grey);">Cancel</button>
      </div>
    </div>


    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script>
      // ⚠️ CONFIGURATION
      const SUPABASE_URL = 'https://ofkswzqvoenwrexolcpm.supabase.co';
      const SUPABASE_KEY = 'sb_publishable_xQ3nwGY_IDTJj9PVDjmslw_NkOGaGg5';
      const _supabase = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

      let globalMembers = [];
      let globalEvents = [];
      let currentEvent = null;
      let attendanceMap = {}; 

      document.addEventListener("DOMContentLoaded", () => {
        checkSession();
      });

      // --- AUTH & AUTO-LOAD LATEST ---
      async function checkSession() {
        const { data: { session } } = await _supabase.auth.getSession();
        if(session) {
           initializeLatestEvent();
        } else {
           goTo('login');
        }
      }

      async function initializeLatestEvent() {
         document.getElementById('view-login').classList.add('hidden');
         document.getElementById('app-wrapper').classList.remove('hidden');
         
         const { data: cols, error } = await _supabase.rpc('get_event_columns');
         
         if(error || !cols || cols.length === 0) {
            goTo('home'); // No events? Go to list to create one
            return;
         }

         globalEvents = cols.map(c => c.column_name).reverse();
         // AUTO-OPEN LATEST
         openEvent(globalEvents[0]); 
      }

      // --- NAVIGATION ---
      function goTo(viewName) {
        document.querySelectorAll('[id^="view-"]').forEach(el => el.classList.add('hidden'));
        document.getElementById('view-login').classList.add('hidden');
        document.getElementById('app-wrapper').classList.add('hidden');

        if(viewName === 'login') {
            document.getElementById('view-login').classList.remove('hidden');
        } else {
            document.getElementById('app-wrapper').classList.remove('hidden');
            document.getElementById(`view-${viewName}`).classList.remove('hidden');
        }

        if(viewName === 'home') loadEventListUI();
        if(viewName === 'report') loadReport();
      }

      function toggleSidebar() {
        const sb = document.getElementById('sidebar');
        const ov = document.getElementById('sidebarOverlay');
        if(sb.classList.contains('active')) {
          sb.classList.remove('active'); ov.style.display='none';
        } else {
          sb.classList.add('active'); ov.style.display='block';
        }
      }

      async function handleLogin() {
        const email = document.getElementById('email').value;
        const password = document.getElementById('password').value;
        const btn = document.getElementById('loginBtn');
        const err = document.getElementById('login-error');
        
        btn.innerText = "Verifying...";
        const { error } = await _supabase.auth.signInWithPassword({ email, password });
        
        if(error) {
           err.innerText = error.message; err.style.display='block'; btn.innerText = "Login Account";
        } else {
           initializeLatestEvent();
        }
      }

      async function handleLogout() {
        await _supabase.auth.signOut();
        window.location.reload();
      }

      // --- ATTENDANCE ---
      async function openEvent(evtName) {
         currentEvent = evtName;
         document.getElementById('currentEventTitle').innerText = evtName;
         document.getElementById('attendanceGrid').innerHTML = '<div style="text-align:center; padding:40px; color:#999;">Loading Data...</div>';
         
         goTo('attendance');

         const memReq = _supabase.from('Members').select('*').order('Mandal').order('Name');
         const attReq = _supabase.from('Attandance').select(`ID, "${evtName}"`);

         const [mRes, aRes] = await Promise.all([memReq, attReq]);

         if(mRes.error) return alert("Error loading members");
         
         globalMembers = mRes.data;
         attendanceMap = {};
         
         if(aRes.data) {
            aRes.data.forEach(row => {
               attendanceMap[row.ID] = row[evtName];
            });
         }
         renderAttendance(globalMembers);
      }

      function renderAttendance(membersToRender) {
         const container = document.getElementById('attendanceGrid');
         container.innerHTML = "";
         
         if(membersToRender.length === 0) {
            container.innerHTML = "<div style='text-align:center; padding:20px; color:#999;'>No members found</div>";
            return;
         }

         const groups = {};
         membersToRender.forEach(m => {
            const grp = m.Mandal || "Other";
            if(!groups[grp]) groups[grp] = [];
            groups[grp].push(m);
         });

         Object.keys(groups).sort().forEach(mandal => {
            const list = groups[mandal];
            const presentCount = list.filter(m => attendanceMap[m.ID]).length;
            
            const card = document.createElement('div');
            card.className = 'mandal-card';
            let rowsHtml = '';
            
            list.forEach(m => {
               const isP = attendanceMap[m.ID] === true;
               rowsHtml += `
                 <div class="user-row">
                    <div style="display:flex; align-items:center; gap:12px;">
                       <div style="width:36px; height:36px; background:#f1f5f9; border-radius:50%; display:flex; align-items:center; justify-content:center; color:var(--primary); font-weight:700; font-size:13px;">
                          ${m.Name.charAt(0)}
                       </div>
                       <div class="user-info">
                          <span class="u-name">${m.Name} ${m.Surname || ''}</span>
                          <span class="u-meta">
                            ID: ${m.ID}
                          </span>
                       </div>
                    </div>
                    <button id="btn-${m.ID}" class="status-btn ${isP ? 'is-present' : 'is-absent'}" 
                       onclick="toggleStatus('${m.ID}', '${mandal}', this)">
                       ${isP ? 'Present' : 'Absent'}
                    </button>
                 </div>
               `;
            });

            card.innerHTML = `
               <div class="mandal-header">
                  <span style="display:flex; align-items:center; gap:8px;">${mandal}</span>
                  <span id="badge-${mandal.replace(/\s/g,'')}" style="background:#e0f2fe; color:var(--primary); padding:4px 10px; border-radius:20px; font-size:12px;">${presentCount} / ${list.length}</span>
               </div>
               <div>${rowsHtml}</div>
            `;
            container.appendChild(card);
         });
      }

      // NEW: SEARCH STUDENTS
      function filterStudents() {
        const term = document.getElementById('studentSearch').value.toLowerCase();
        const filtered = globalMembers.filter(m => 
           m.Name.toLowerCase().includes(term) || 
           (m.Surname || "").toLowerCase().includes(term) ||
           String(m.ID).includes(term)
        );
        renderAttendance(filtered);
      }

      async function toggleStatus(id, mandal, btn) {
         const isPresent = !btn.classList.contains('is-present');
         btn.className = `status-btn ${isPresent ? 'is-present' : 'is-absent'}`;
         btn.innerText = isPresent ? 'Present' : 'Absent';
         attendanceMap[id] = isPresent;
         
         // Update Badge (Find all members of this mandal, check status)
         const grpMembers = globalMembers.filter(m => (m.Mandal||"Other") === mandal);
         const pCount = grpMembers.filter(m => attendanceMap[m.ID]).length;
         
         const badge = document.getElementById(`badge-${mandal.replace(/\s/g,'')}`);
         if(badge) badge.innerText = `${pCount} / ${grpMembers.length}`;

         const payload = { ID: id };
         payload[currentEvent] = isPresent;
         await _supabase.from('Attandance').upsert(payload);
      }

      // --- EVENT LIST ---
      function loadEventListUI() { renderEventList(globalEvents); }

      function renderEventList(events) {
        const container = document.getElementById('eventListContainer');
        container.innerHTML = "";
        events.forEach(evtName => {
           const div = document.createElement('div');
           div.className = 'event-card';
           div.onclick = () => openEvent(evtName);
           div.innerHTML = `
             <div style="display:flex; justify-content:space-between; align-items:center;">
               <div style="font-weight:700; font-size:16px; color:var(--text-dark);">${evtName}</div>
               <svg class="icon" style="color:#cbd5e1;" viewBox="0 0 24 24"><polyline points="9 18 15 12 9 6"></polyline></svg>
             </div>
             <div style="font-size:12px; color:var(--text-grey); margin-top:5px;">Tap to view attendance</div>
           `;
           container.appendChild(div);
        });
      }
      
      function filterEvents() {
        const term = document.getElementById('eventSearch').value.toLowerCase();
        renderEventList(globalEvents.filter(e => e.toLowerCase().includes(term)));
      }

      function showAddModal() { document.getElementById('addModal').style.display='flex'; }
      
      async function addNewEvent() {
        const name = document.getElementById('newEventInput').value.trim();
        if(!name) return;
        
        const btn = document.querySelector('#addModal .btn-primary');
        btn.innerText = "Creating...";
        
        const { error } = await _supabase.rpc('add_event_column', { column_name: name });
        if(error) {
           alert(error.message);
           btn.innerText = "Create Event";
        } else {
           document.getElementById('addModal').style.display='none';
           btn.innerText = "Create Event";
           // Reload logic
           const { data: cols } = await _supabase.rpc('get_event_columns');
           globalEvents = cols.map(c => c.column_name).reverse();
           openEvent(name);
        }
      }

      // --- REPORT ---
      function loadReport() {
         const tbody = document.getElementById('reportTableBody');
         tbody.innerHTML = "";
         const groups = {};
         globalMembers.forEach(m => {
            const grp = m.Mandal || "Other";
            if(!groups[grp]) groups[grp] = { total: 0, present: 0 };
            groups[grp].total++;
            if(attendanceMap[m.ID]) groups[grp].present++;
         });
         
         let gT = 0, gP = 0;
         Object.keys(groups).sort().forEach(m => {
            const d = groups[m];
            gT += d.total; gP += d.present;
            const pct = Math.round((d.present/d.total)*100)||0;
            tbody.innerHTML += `<tr><td>${m}</td><td>${d.present}</td><td>${d.total}</td><td>${pct}%</td></tr>`;
         });
         const totPct = Math.round((gP/gT)*100)||0;
         tbody.innerHTML += `<tr class="r-total-row"><td>Total</td><td>${gP}</td><td>${gT}</td><td>${totPct}%</td></tr>`;
      }

      function downloadCSV() {
         let csv = "ID,Name,Mandal,Status,Event\n";
         globalMembers.forEach(m => {
            csv += `${m.ID},"${m.Name}",${m.Mandal},${attendanceMap[m.ID]?"Present":"Absent"},${currentEvent}\n`;
         });
         const a = document.createElement('a');
         a.href = window.URL.createObjectURL(new Blob([csv], { type: 'text/csv' }));
         a.download = `${currentEvent}_Report.csv`;
         a.click();
      }
    </script>
  </body>
</html>
